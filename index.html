<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Core/Accessory Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#fff8f0; --card:#fff; --muted:#666; --line:#eee; --brand:#E97400; }
    *{box-sizing:border-box}
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:#222; margin:0; }
    header{ padding:16px 20px; border-bottom:1px solid var(--line); }
    h1{ margin:0; font-size:18px; }

    .wrap{ display:flex; gap:24px; padding:20px; max-width:1200px; margin:0 auto; }
    .left{ width:38%; max-width:520px; }
    .right{ flex:1; min-width:0; }

    fieldset{ border:1px solid var(--line); border-radius:12px; padding:16px; margin-bottom:16px; background:var(--card); }
    legend{ font-weight:600; padding:0 6px; }
    label{ display:block; font-weight:600; margin-top:8px; }

    select,input[type="text"]{
      width:100%; padding:12px; margin-top:6px; border:1px solid #ddd; border-radius:10px; font-size:16px; background:#fff;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    button{ padding:12px 14px; border:0; border-radius:10px; background:var(--brand); color:#fff; cursor:pointer; font-size:16px; }
    button.secondary{ background:#e0e0e0; color:#222; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .error{ color:#c62828; margin:8px 0; font-weight:600; }
    .ok{ color:#2e7d32; margin:8px 0; font-weight:600; }
    .muted{ color:var(--muted); font-size:12px; }
    .subhead{ font-weight:700; margin:4px 0 8px; }

    /* Separators between search methods */
    .divider{ display:flex; align-items:center; gap:10px; margin:12px 0 16px; }
    .divider::before,.divider::after{ content:""; height:1px; background:var(--line); flex:1; }
    .divider span{ font-size:12px; color:#888; text-transform:uppercase; letter-spacing:.08em; background:transparent; padding:0 2px; }

    /* Tables */
    .table-wrap{ width:100%; overflow-x:visible; } /* no horizontal scroll on mobile */
    table{ width:100%; border-collapse:collapse; margin-top:10px; background:#fff; min-width:0; }
    th,td{ border-bottom:1px solid var(--line); text-align:left; padding:10px; }
    th{ background:#fafafa; }

    /* Main result table columns on mobile: 30% / 70% */
    .result-table td.label{ width:30%; max-width:30%; vertical-align:top; color:#555; font-weight:600; }
    .result-table td.value{ width:70%; max-width:70%; vertical-align:top; word-break:break-word; overflow-wrap:anywhere; }

    /* Related as cards (mobile) */
    .related-cards{ display:none; }
    .card{ border:1px solid var(--line); border-radius:10px; padding:10px; background:#fff; }
    .card .title{ font-weight:700; margin-bottom:6px; }
    .card .line{ color:#333; font-size:14px; margin-top:4px; }
    .card .muted{ color:var(--muted); font-size:12px; margin-top:4px; }
    .card a{ font-weight:600; }

    .section-gap{ height:10px; } /* visual break before related header */

    /* Layout breakpoints */
    @media (max-width:900px){
      .wrap{ flex-direction:column; padding:12px; }
      .left{ width:100%; max-width:none; }
    }
    /* Mobile: show 2-column cards; main table already 100% width */
    @media (max-width:600px){
      .related-table{ display:none; }
      .related-cards{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
      #backToTop{ display:inline-flex; }
    }

    /* Mobile-only floating button */
    #backToTop{
      position:fixed; right:16px; bottom:16px; padding:12px 14px;
      border-radius:999px; background:#000; color:#fff; border:0; display:none; z-index:999;
    }
  </style>
  <script>
    window.API_BASE = "https://core-accessory-tool-production.up.railway.app";
  </script>
</head>
<body>
<header>
  <h1>Find the Accessory / Core Item</h1>
</header>

<div class="wrap">
  <div class="left">
    <fieldset>
      <legend>Search by dropdown</legend>
      <label for="type">Type</label>
      <select id="type"><option value="">— Select Type —</option></select>

      <label for="department">Category</label>
      <select id="department"><option value="">— Select Category —</option></select>

      <label for="brand">Brand</label>
      <select id="brand"><option value="">— Select Brand —</option></select>

      <label for="item_name">Item Name</label>
      <select id="item_name"><option value="">— Select Item —</option></select>

      <div class="row" style="margin-top:12px">
        <button id="btnDropdown">Search</button>
        <button class="secondary" id="btnResetDropdown" type="button">Reset</button>
      </div>
    </fieldset>

    <div class="divider"><span>or</span></div>

    <fieldset>
      <legend>Search by product page link</legend>
      <label for="product_link">URL</label>
      <input id="product_link" type="text" placeholder="" />
      <div class="row" style="margin-top:12px">
        <button id="btnLink">Search</button>
        <button class="secondary" id="btnResetLink" type="button">Reset</button>
      </div>
    </fieldset>

    <div class="divider"><span>or</span></div>

    <fieldset>
      <legend>Search by product number</legend>
      <label for="product_number">SKU</label>
      <input id="product_number" type="text" placeholder="e.g. 12345678" maxlength="8" />
      <div class="row" style="margin-top:12px">
        <button id="btnNumber">Search</button>
        <button class="secondary" id="btnResetNumber" type="button">Reset</button>
      </div>
    </fieldset>

    <div id="msg"></div>
  </div>

  <div class="right">
    <fieldset id="results">
      <legend>Result</legend>
      <div id="resultBox" class="muted">No selection yet.</div>
      <div class="section-gap"></div>
      <div id="relatedHeader" class="subhead" style="display:none;"></div>
      <div id="relatedBox"></div>
    </fieldset>
  </div>
</div>

<button id="backToTop" class="mobile-only" title="Back to Top">Back to Top</button>

<script>
  const API_BASE = window.API_BASE;
  const el = (id)=>document.getElementById(id);
  const $type=el("type"), $dept=el("department"), $brand=el("brand"), $name=el("item_name");
  const $msg=el("msg"), $resultBox=el("resultBox"), $relatedBox=el("relatedBox"), $relatedHeader=el("relatedHeader");
  const $backTop = el("backToTop");

  const isMobile = ()=> window.innerWidth <= 900;
  const setMsg=(t,ok=false)=>{ $msg.innerHTML = t ? `<div class="${ok?"ok":"error"}">${t}</div>` : ""; };

  const nanLike = (v)=>{
    if (v === null || v === undefined) return true;
    const s = String(v).trim().toLowerCase();
    return s === "" || s === "nan" || s === "none" || s === "null";
  };

  function formatHKD(v){
    const n = Number(v);
    if (Number.isFinite(n)) return "HK$" + n.toLocaleString("en-HK", { maximumFractionDigits: 0 });
    return nanLike(v) ? "" : `HK$${v}`;
  }

  async function fetchMeta(){
    const p = new URLSearchParams();
    if ($type.value) p.set("type",$type.value);
    if ($dept.value) p.set("department",$dept.value);
    if ($brand.value) p.set("brand",$brand.value);
    const res = await fetch(`${API_BASE}/api/meta?`+p.toString());
    if(!res.ok) throw new Error("meta failed");
    return res.json();
  }

  function fillSelect($sel, items, fmt=(x)=>x, val=(x)=>x, keep=false){
    const cur = keep ? $sel.value : "";
    $sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value=""; opt0.textContent="— Select —"; $sel.appendChild(opt0);
    items.forEach(i=>{
      const o=document.createElement("option"); o.value=val(i); o.textContent=fmt(i); $sel.appendChild(o);
    });
    if(keep && items.includes(cur)) $sel.value=cur;
  }

  async function refreshDropdowns(){
    try{
      const meta = await fetchMeta();
      fillSelect($type, meta.types, t=> t==="A"?"Accessory":"Core Item", t=>t, true);
      fillSelect($dept, meta.departments, d=>d, d=>d, true);
      fillSelect($brand, meta.brands, b=>b, b=>b, true);
      fillSelect($name, meta.item_names, n=>n, n=>n);
    }catch(e){ setMsg("Failed to load dropdowns. Please retry."); console.error(e); }
  }

  function fortressUrlFromSku(sku){
    return sku && /^\d{8}$/.test(sku) ? `https://fortress.com.hk/p/${sku}` : "";
  }

  function renderMainResult(r){
    const displayName = r.item_name_retek ?? r["Item Name (retek)"] ?? r.item_name;

    let html = `<div class="subhead">You are currently searching for</div>`;
    const rows = [];
    const pushRow = (label, value) => {
      if(!nanLike(value)) rows.push(`<tr><td class="label">${label}</td><td class="value">${value}</td></tr>`);
    };

    pushRow("Category", r.department);
    pushRow("Brand", r.brand);
    pushRow("Item Name", displayName);
    pushRow("Type", r.type_label);
    if(!nanLike(r.rrp)) pushRow("RRP", formatHKD(r.rrp));

    const productUrl = fortressUrlFromSku(r.item);
    if(productUrl) pushRow("Product Link", `<a href="${productUrl}" target="_blank" rel="noopener">View</a>`);

    html += `<div class="table-wrap"><table class="result-table"><tbody>${rows.join("") || `<tr><td class="value muted">No details available.</td></tr>`}</tbody></table></div>`;
    $resultBox.innerHTML = html;
  }

  function renderRelated(items, currentType){
    const clean = items.filter(x=>{
      const name = x["Item Name (retek)"] ?? x["Item Name"];
      const fields = [x.Brand, x.Department, name];
      return !fields.some(nanLike);
    });

    if (!clean.length){
      $relatedHeader.style.display = "none";
      $relatedBox.innerHTML = "<div class='muted'>No related items found.</div>";
      return;
    }

    const headerText = currentType === "Core Item" ? "The related accessories:" : "The related core items:";
    $relatedHeader.textContent = headerText;
    $relatedHeader.style.display = "block";

    /* Desktop table (short labels) */
    const rows = clean.map(x=>{
      const name = x["Item Name (retek)"] ?? x["Item Name"] ?? "";
      const url = fortressUrlFromSku(x.Item);
      const link = url ? `<a href="${url}" target="_blank" rel="noopener">View</a>` : "—";
      return `<tr>
        <td>${x.Brand || ""}</td>
        <td>${x.Department || ""}</td>
        <td>${name}</td>
        <td>${formatHKD(x.RRP)}</td>
        <td>${link}</td>
      </tr>`;
    }).join("");

    /* Mobile cards (2 per row): 
       Row1: Name
       Row2: Brand: ...
       Row3: Category: ...
       Row4: HK$...
       Row5: View (link)
    */
    const cards = clean.map(x=>{
      const name = x["Item Name (retek)"] ?? x["Item Name"] ?? "";
      const url = fortressUrlFromSku(x.Item);
      return `<div class="card">
        <div class="title">${name}</div>
        <div class="line">Brand: ${x.Brand || ""}</div>
        <div class="line">Category: ${x.Department || ""}</div>
        ${!nanLike(x.RRP) ? `<div class="line">${formatHKD(x.RRP)}</div>` : ""}
        ${url ? `<div class="line"><a href="${url}" target="_blank" rel="noopener">View</a></div>` : ""}
      </div>`;
    }).join("");

    $relatedBox.innerHTML = `
      <div class="table-wrap related-table">
        <table>
          <thead><tr><th>Brand</th><th>Category</th><th>Item Name</th><th>Price</th><th>Link</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div class="related-cards">
        ${cards}
      </div>`;
  }

  async function doSearch(payload){
    setMsg(""); $resultBox.textContent="Searching…"; $relatedBox.innerHTML=""; $relatedHeader.style.display="none";
    try{
      const res = await fetch(`${API_BASE}/api/search`, {
        method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok){ $resultBox.innerHTML=""; setMsg(data.error||"Search failed."); return; }
      renderMainResult(data.result);
      renderRelated(data.related_items||[], data.result.type_label);

      if (isMobile()){
        document.getElementById("results").scrollIntoView({behavior:"smooth", block:"start"});
        $backTop.style.display = "inline-flex";
      }
    }catch(e){ $resultBox.innerHTML=""; setMsg("Can’t reach backend. Check API_BASE/CORS."); console.error(e); }
  }

  // Events
  $type.addEventListener("change", refreshDropdowns);
  $dept.addEventListener("change", refreshDropdowns);
  $brand.addEventListener("change", refreshDropdowns);

  document.getElementById("btnDropdown").addEventListener("click", async ()=>{
    const v = document.getElementById("item_name").value.trim();
    if(!v) return setMsg("Please select the product.");
    await doSearch({ action:"dropdown", selected_item_name:v });
  });
  document.getElementById("btnResetDropdown").addEventListener("click", async ()=>{
    document.getElementById("type").value=""; document.getElementById("department").value="";
    document.getElementById("brand").value=""; document.getElementById("item_name").value="";
    await refreshDropdowns(); setMsg(""); $resultBox.textContent="No selection yet."; $relatedBox.innerHTML=""; $relatedHeader.style.display="none";
    $backTop.style.display = "none";
  });

  document.getElementById("btnLink").addEventListener("click", async ()=>{
    const url = document.getElementById("product_link").value.trim();
    if(!url) return setMsg("Please paste a product link.");
    await doSearch({ action:"link", product_link:url });
  });
  document.getElementById("btnResetLink").addEventListener("click", ()=>{
    document.getElementById("product_link").value=""; setMsg("");
  });

  document.getElementById("btnNumber").addEventListener("click", async ()=>{
    const v = document.getElementById("product_number").value.trim();
    if(!/^\d{8}$/.test(v)) return setMsg("Please enter an 8-digit product number.");
    await doSearch({ action:"number", product_number:v });
  });
  document.getElementById("btnResetNumber").addEventListener("click", ()=>{
    document.getElementById("product_number").value=""; setMsg("");
  });

  document.getElementById("backToTop").addEventListener("click", ()=>{ window.scrollTo({top:0, behavior:"smooth"}); });

  // init
  refreshDropdowns();
</script>
</body>
</html>
