<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Core/Accessory Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#fff8f0; --card:#fff; --muted:#666; --line:#eee; --brand:#E97400; }
    *{box-sizing:border-box}
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:#222; margin:0; }
    header{ padding:16px 20px; border-bottom:1px solid var(--line); }
    h1{ margin:0; font-size:18px; }

    .wrap{ display:flex; gap:24px; padding:20px; max-width:1200px; margin:0 auto; }
    .left{ width:38%; max-width:520px; }
    .right{ flex:1; min-width:0; }

    fieldset{ border:1px solid var(--line); border-radius:12px; padding:16px; margin-bottom:16px; background:var(--card); }
    legend{ font-weight:600; padding:0 6px; }
    label{ display:block; font-weight:600; margin-top:8px; }

    select,input[type="text"]{ width:100%; padding:12px; margin-top:6px; border:1px solid #ddd; border-radius:10px; font-size:16px; background:#fff; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    button{ padding:12px 14px; border:0; border-radius:10px; background:var(--brand); color:#fff; cursor:pointer; font-size:16px; }
    button.secondary{ background:#e0e0e0; color:#222; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .error{ color:#c62828; margin:8px 0; font-weight:600; }
    .ok{ color:#2e7d32; margin:8px 0; font-weight:600; }
    .muted{ color:var(--muted); font-size:12px; }
    .note-unavailable{ color:var(--muted); font-style:italic; }
    .subhead{ font-weight:700; margin:4px 0 8px; }

    .divider{ display:flex; align-items:center; gap:10px; margin:12px 0 16px; }
    .divider::before,.divider::after{ content:""; height:1px; background:var(--line); flex:1; }
    .divider span{ font-size:12px; color:#888; text-transform:uppercase; letter-spacing:.08em; padding:0 2px; }

    .table-wrap{ width:100%; overflow-x:visible; }
    table{ width:100%; border-collapse:collapse; margin-top:10px; background:#fff; min-width:0; }
    th,td{ border-bottom:1px solid var(--line); text-align:left; padding:10px; }
    th{ background:#fafafa; }

    .result-table td.label{ width:30%; max-width:30%; vertical-align:top; color:#555; font-weight:600; }
    .result-table td.value{ width:70%; max-width:70%; vertical-align:top; word-break:break-word; overflow-wrap:anywhere; }

    .related-cards{ display:none; }
    .card{ border:1px solid var(--line); border-radius:10px; padding:10px; background:#fff; }
    .card .title{ font-weight:700; margin-bottom:6px; }
    .card .line{ color:#333; font-size:14px; margin-top:4px; }
    .card a{ font-weight:600; }

    /* Autocomplete dropdown */
    .suggestbox{ position:relative; }
    .suggestions{
      position:absolute; left:0; right:0; top:100%; z-index:50;
      background:#fff; border:1px solid #ddd; border-radius:8px;
      max-height:260px; overflow:auto; margin-top:4px; box-shadow:0 8px 24px rgba(0,0,0,.08);
    }
    .suggestions div{ padding:10px 12px; cursor:pointer; }
    .suggestions div:hover, .suggestions div.active{ background:#f6f6f6; }
    .suggestions .nohit{ color:var(--muted); cursor:default; }

    .section-gap{ height:10px; }

    @media (max-width:900px){
      .wrap{ flex-direction:column; padding:12px; }
      .left{ width:100%; max-width:none; }
    }
    @media (max-width:600px){
      .related-table{ display:none; }
      .related-cards{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
      #backToTop{ display:inline-flex; }
    }

    #backToTop{
      position:fixed; right:16px; bottom:16px; padding:12px 14px;
      border-radius:999px; background:#000; color:#fff; border:0; display:none; z-index:999;
    }
  </style>
  <script>
    window.API_BASE = "https://core-accessory-tool-production.up.railway.app";
  </script>
</head>
<body>
<header>
  <h1>Find the Accessory / Core Item</h1>
</header>

<div class="wrap">
  <div class="left">
    <!-- 1) Search by dropdown -->
    <fieldset>
      <legend>Search by dropdown</legend>

      <label for="type">Type</label>
      <select id="type"><option value="">— Select Type —</option></select>

      <label for="department">Category</label>
      <select id="department" disabled><option value="">— Select Category —</option></select>

      <label for="brand">Brand</label>
      <select id="brand" disabled><option value="">— Select Brand —</option></select>

      <label for="item_name">Item name</label>
      <select id="item_name" disabled><option value="">— Select Item —</option></select>

      <div class="row" style="margin-top:12px">
        <button id="btnDropdown">Search</button>
        <button class="secondary" id="btnResetDropdown" type="button">Reset</button>
      </div>
      <div id="msgDropdown"></div>
    </fieldset>

    <div class="divider"><span>or</span></div>

    <!-- 2) Search by product name (moved above link search) -->
    <fieldset>
      <legend>Search by product name</legend>
      <label for="product_name">Enter keywords</label>
      <div class="suggestbox">
        <input id="product_name" type="text" autocomplete="off" placeholder="e.g. Dyson HS08" />
        <div id="name_suggestions" class="suggestions" style="display:none;"></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnName">Search</button>
        <button class="secondary" id="btnResetName" type="button">Reset</button>
      </div>
      <div id="msgName"></div>
    </fieldset>

    <div class="divider"><span>or</span></div>

    <!-- 3) Search by product page link (now last) -->
    <fieldset>
      <legend>Search by product page link</legend>
      <label for="product_link">URL</label>
      <input id="product_link" type="text" placeholder="" />
      <div class="row" style="margin-top:12px">
        <button id="btnLink">Search</button>
        <button class="secondary" id="btnResetLink" type="button">Reset</button>
      </div>
      <div id="msgLink"></div>
    </fieldset>
  </div>

  <div class="right">
    <fieldset id="results">
      <legend>Result</legend>
      <div id="resultBox" class="muted">No selection yet.</div>
      <div class="section-gap"></div>
      <div id="relatedHeader" class="subhead" style="display:none;"></div>
      <div id="relatedBox"></div>
    </fieldset>
  </div>
</div>

<button id="backToTop" class="mobile-only" title="Back to Top">Back to Top</button>

<script>
  const API_BASE = window.API_BASE;
  const el = (id)=>document.getElementById(id);

  // Dropdown els
  const $type=el("type"), $dept=el("department"), $brand=el("brand"), $name=el("item_name");
  const $msgDropdown=el("msgDropdown"), $msgLink=el("msgLink"), $msgName=el("msgName");

  // Result els
  const $resultBox=el("resultBox"), $relatedBox=el("relatedBox"), $relatedHeader=el("relatedHeader");
  const $backTop = el("backToTop");

  // Name search els/state
  const $productName = el("product_name");
  const $suggestions = el("name_suggestions");
  let selectedName = ""; // must be set by clicking a suggestion

  const isMobile = ()=> window.innerWidth <= 900;
  const setMsg=(node,t,ok=false)=>{ node.innerHTML = t ? `<div class="${ok?"ok":"error"}">${t}</div>` : ""; };

  // Escape to prevent XSS if spreadsheet contains HTML-like text
  function esc(s){
    return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
                    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  const nanLike = (v)=>{
    if (v === null || v === undefined) return true;
    const s = String(v).trim().toLowerCase();
    return s === "" || s === "nan" || s === "none" || s === "null";
  };

  function formatHKD(v){
    const n = Number(v);
    if (Number.isFinite(n)) return "HK$" + n.toLocaleString("en-HK", { maximumFractionDigits: 0 });
    return nanLike(v) ? "" : `HK$${esc(v)}`;
  }

  async function fetchMeta(){
    const p = new URLSearchParams();
    if ($type.value) p.set("type",$type.value);
    if ($dept.value) p.set("department",$dept.value);
    if ($brand.value) p.set("brand",$brand.value);
    const res = await fetch(`${API_BASE}/api/meta?`+p.toString(), { headers: { "X-Requested-With": "core-accessory-tool" }});
    if(!res.ok) throw new Error("meta failed");
    return res.json();
  }

  function fillSelect($sel, items, fmt=(x)=>x, val=(x)=>x, keep=false){
    const cur = keep ? $sel.value : "";
    $sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value=""; opt0.textContent="— Select —"; $sel.appendChild(opt0);
    items.forEach(i=>{
      const o=document.createElement("option"); o.value=val(i); o.textContent=fmt(i); $sel.appendChild(o);
    });
    if(keep && items.includes(cur)) $sel.value=cur;
  }

  async function refreshDropdowns(){
    try{
      const meta = await fetchMeta();
      // Always refresh types
      fillSelect($type, meta.types, t=> t==="A"?"Accessory":"Core Item", t=>t, true);

      // Only populate following selects if they are enabled/allowed by the step
      if (!$dept.disabled) fillSelect($dept, meta.departments, d=>d, d=>d, true);
      if (!$brand.disabled) fillSelect($brand, meta.brands, b=>b, b=>b, true);

      if (!$name.disabled) {
        if (meta.item_names && meta.item_names.length){
          fillSelect($name, meta.item_names, n=>n, n=>n);
        } else {
          $name.innerHTML = "";
          const o=document.createElement("option"); o.value=""; o.textContent="— No items —"; $name.appendChild(o);
        }
      }
    }catch(e){ setMsg($msgDropdown,"Failed to load dropdowns. Please retry."); console.error(e); }
  }

  function fortressUrlFromSku(sku){
    return sku && /^\d{8}$/.test(sku) ? `https://fortress.com.hk/p/${sku}` : "";
  }

  function renderMainResult(r){
    const displayName = r.item_name_retek ?? r["Item Name (retek)"] ?? r.item_name;

    let html = `<div class="subhead">You are currently searching for</div>`;
    const rows = [];
    const pushRow = (label, value, isHTML=false) => {
      if(!nanLike(value)) rows.push(
        `<tr><td class="label">${esc(label)}</td><td class="value">${isHTML ? value : esc(value)}</td></tr>`
      );
    };

    pushRow("Category", r.department);
    pushRow("Brand", r.brand);
    pushRow("Item name", displayName);
    pushRow("Type", r.type_label);
    if(!nanLike(r.rrp)) pushRow("RRP", formatHKD(r.rrp), true);

    // Product link with Allow To Buy
    if (Number(r.allow_to_buy) === 1){
      const productUrl = fortressUrlFromSku(r.item);
      if(productUrl) pushRow("Product Link", `<a href="${productUrl}" target="_blank" rel="noopener">View</a>`, true);
    } else {
      pushRow("Product Link", `<span class="note-unavailable">This item is no longer available.</span>`, true);
    }

    html += `<div class="table-wrap"><table class="result-table"><tbody>${rows.join("") || `<tr><td class="value muted">No details available.</td></tr>`}</tbody></table></div>`;
    $resultBox.innerHTML = html;
  }

  function renderRelated(items, currentType){
    const clean = items.filter(x=>{
      const name = x["Item Name (retek)"] ?? x["Item Name"];
      const fields = [x.Brand, x.Department, name];
      return !fields.some(nanLike);
    });

    if (!clean.length){
      $relatedHeader.style.display = "none";
      $relatedBox.innerHTML = "<div class='muted'>No related items found.</div>";
      return;
    }

    const headerText = currentType === "Core Item" ? "The related accessories:" : "The related core items:";
    $relatedHeader.textContent = headerText;
    $relatedHeader.style.display = "block";

    // Desktop table
    const rows = clean.map(x=>{
      const name = x["Item Name (retek)"] ?? x["Item Name"] ?? "";
      const url = fortressUrlFromSku(x.Item);
      let linkCell = "—";
      if (Number(x["Allow To Buy"]) === 1 && url) linkCell = `<a href="${url}" target="_blank" rel="noopener">View</a>`;
      if (Number(x["Allow To Buy"]) !== 1) linkCell = `<span class="note-unavailable">This item is no longer available.</span>`;
      return `<tr>
        <td>${esc(x.Brand || "")}</td>
        <td>${esc(x.Department || "")}</td>
        <td>${esc(name)}</td>
        <td>${formatHKD(x.RRP)}</td>
        <td>${linkCell}</td>
      </tr>`;
    }).join("");

    // Mobile cards (2 per row)
    const cards = clean.map(x=>{
      const name = x["Item Name (retek)"] ?? x["Item Name"] ?? "";
      const url = fortressUrlFromSku(x.Item);
      let tail = "";
      if (Number(x["Allow To Buy"]) === 1 && url) tail = `<div class="line"><a href="${url}" target="_blank" rel="noopener">View</a></div>`;
      if (Number(x["Allow To Buy"]) !== 1) tail = `<div class="line note-unavailable">This item is no longer available.</div>`;
      return `<div class="card">
        <div class="title">${esc(name)}</div>
        <div class="line">Brand: ${esc(x.Brand || "")}</div>
        <div class="line">Category: ${esc(x.Department || "")}</div>
        ${!nanLike(x.RRP) ? `<div class="line">${formatHKD(x.RRP)}</div>` : ""}
        ${tail}
      </div>`;
    }).join("");

    $relatedBox.innerHTML = `
      <div class="table-wrap related-table">
        <table>
          <thead><tr><th>Brand</th><th>Category</th><th>Item name</th><th>RRP</th><th>Link</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div class="related-cards">
        ${cards}
      </div>`;
  }

  async function doSearch(payload, source){
    // Clear messages
    setMsg($msgDropdown,""); setMsg($msgLink,""); setMsg($msgName,"");

    // Clear other sections when one starts a search
    if (source === "dropdown"){
      el("product_link").value = "";
      $productName.value = ""; selectedName = ""; $suggestions.style.display="none"; $suggestions.innerHTML="";
    } else if (source === "link"){
      $type.value=""; $dept.value=""; $brand.value=""; $name.value="";
      $type.disabled=false; $dept.disabled=true; $brand.disabled=true; $name.disabled=true;
      el("item_name").innerHTML = "<option value=''>— Select Item —</option>";
      el("department").innerHTML = "<option value=''>— Select Category —</option>";
      el("brand").innerHTML = "<option value=''>— Select Brand —</option>";
      refreshDropdowns();
      $productName.value = ""; selectedName = ""; $suggestions.style.display="none"; $suggestions.innerHTML="";
    } else if (source === "name"){
      el("product_link").value = "";
      $type.value=""; $dept.value=""; $brand.value=""; $name.value="";
      $type.disabled=false; $dept.disabled=true; $brand.disabled=true; $name.disabled=true;
      el("item_name").innerHTML = "<option value=''>— Select Item —</option>";
      el("department").innerHTML = "<option value=''>— Select Category —</option>";
      el("brand").innerHTML = "<option value=''>— Select Brand —</option>";
      refreshDropdowns();
    }

    $resultBox.textContent="Searching…"; $relatedBox.innerHTML=""; $relatedHeader.style.display="none";
    try{
      const res = await fetch(`${API_BASE}/api/search`, {
        method:"POST",
        headers:{"Content-Type":"application/json","X-Requested-With":"core-accessory-tool"},
        body:JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok){ $resultBox.innerHTML=""; 
        const msg = data && data.error ? data.error : "Search failed.";
        if (source==="dropdown") setMsg($msgDropdown, msg);
        if (source==="link") setMsg($msgLink, msg);
        if (source==="name") setMsg($msgName, msg);
        return;
      }
      renderMainResult(data.result);
      renderRelated(data.related_items||[], data.result.type_label);

      if (isMobile()){
        document.getElementById("results").scrollIntoView({behavior:"smooth", block:"start"});
        $backTop.style.display = "inline-flex";
      }
    }catch(e){ 
      $resultBox.innerHTML="";
      const msg = "Can’t reach backend. Check API_BASE/CORS.";
      if (source==="dropdown") setMsg($msgDropdown, msg);
      if (source==="link") setMsg($msgLink, msg);
      if (source==="name") setMsg($msgName, msg);
      console.error(e);
    }
  }

  // ───── Dropdown stepper behavior ─────
  async function onTypeChange(){
    if (!$type.value){ return; }
    $type.disabled = true;          // lock
    $dept.disabled = false;         // enable next
    await refreshDropdowns();
  }
  async function onDeptChange(){
    if (!$dept.value){ return; }
    $dept.disabled = true;          // lock
    $brand.disabled = false;        // enable next
    await refreshDropdowns();
  }
  async function onBrandChange(){
    if (!$brand.value){ return; }
    $brand.disabled = true;         // lock
    $name.disabled = false;         // enable next
    await refreshDropdowns();
  }
  function onNameChange(){
    if ($name.value){ $name.disabled = true; } // lock once chosen
  }

  // ───── Name search (autocomplete) ─────
  let suggestTimer = null;
  async function fetchSuggestions(q){
    const p = new URLSearchParams({ q });
    const res = await fetch(`${API_BASE}/api/suggest?`+p.toString(), { headers: { "X-Requested-With": "core-accessory-tool" }});
    if (!res.ok) return { suggestions: [] };
    return res.json();
  }
  function renderSuggestions(list, q){
    if (!q) { $suggestions.style.display="none"; $suggestions.innerHTML=""; return; }
    if (!list || !list.length){
      $suggestions.innerHTML = `<div class="nohit">No item(s) found. Try fewer keywords or ‘select by dropdown’.</div>`;
      $suggestions.style.display="block";
      return;
    }
    $suggestions.innerHTML = list.map(n=>`<div data-name="${n.replace(/"/g,"&quot;")}">${esc(n)}</div>`).join("");
    $suggestions.style.display="block";
  }

  $suggestions.addEventListener("click", (e)=>{
    const div = e.target.closest("div[data-name]");
    if(!div) return; // ignore clicks on "nohit"
    selectedName = div.getAttribute("data-name");
    $productName.value = selectedName;
    $suggestions.style.display="none";
    $suggestions.innerHTML="";
  });

  $productName.addEventListener("input", ()=>{
    selectedName = ""; // typing cancels selection
    const q = $productName.value.trim();
    if (suggestTimer) clearTimeout(suggestTimer);
    if (!q){ $suggestions.style.display="none"; $suggestions.innerHTML=""; return; }
    suggestTimer = setTimeout(async ()=>{
      try{
        const data = await fetchSuggestions(q);
        renderSuggestions(data.suggestions || [], q);
      }catch{ renderSuggestions([], q); }
    }, 200);
  });

  // ───── Events ─────
  $type.addEventListener("change", onTypeChange);
  $dept.addEventListener("change", onDeptChange);
  $brand.addEventListener("change", onBrandChange);
  $name.addEventListener("change", onNameChange);

  document.getElementById("btnDropdown").addEventListener("click", async ()=>{
    setMsg($msgDropdown,"");
    if(!$name.value) return setMsg($msgDropdown,"Please select the product.");
    await doSearch({ action:"dropdown", selected_item_name:$name.value.trim() }, "dropdown");
  });
  document.getElementById("btnResetDropdown").addEventListener("click", async ()=>{
    setMsg($msgDropdown,"");
    $type.disabled=false; $dept.disabled=true; $brand.disabled=true; $name.disabled=true;
    $type.value=""; $dept.value=""; $brand.value=""; $name.value="";
    el("department").innerHTML = "<option value=''>— Select Category —</option>";
    el("brand").innerHTML = "<option value=''>— Select Brand —</option>";
    el("item_name").innerHTML = "<option value=''>— Select Item —</option>";
    await refreshDropdowns();
    $resultBox.textContent="No selection yet."; $relatedBox.innerHTML=""; $relatedHeader.style.display="none";
    $backTop.style.display = "none";
  });

  document.getElementById("btnLink").addEventListener("click", async ()=>{
    setMsg($msgLink,"");
    const url = document.getElementById("product_link").value.trim();
    if(!url) return setMsg($msgLink,"Please paste a product link.");
    await doSearch({ action:"link", product_link:url }, "link");
  });
  document.getElementById("btnResetLink").addEventListener("click", ()=>{
    setMsg($msgLink,"");
    document.getElementById("product_link").value="";
  });

  document.getElementById("btnName").addEventListener("click", async ()=>{
    setMsg($msgName,"");
    if (!selectedName || selectedName !== $productName.value.trim()){
      return setMsg($msgName,"Please select an item from the suggestions list.");
    }
    await doSearch({ action:"dropdown", selected_item_name:selectedName }, "name");
  });
  document.getElementById("btnResetName").addEventListener("click", ()=>{
    setMsg($msgName,"");
    $productName.value = ""; selectedName=""; $suggestions.style.display="none"; $suggestions.innerHTML="";
  });

  document.getElementById("backToTop").addEventListener("click", ()=>{ window.scrollTo({top:0, behavior:"smooth"}); });

  // init
  refreshDropdowns();
</script>
</body>
</html>
